<!doctype html><html lang=en-US><head><meta http-equiv=X-Clacks-Overhead content="GNU Terry Pratchett"><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" href=https://blog.thibaud.io/images/favicon.png><title>Skaffold with ECR and replication | rheneross</title>
<meta name=title content="Skaffold with ECR and replication"><meta name=description content="Our product is deployed on kubernetes, and the dev team was working locally; which meant a lot of integration issues.
We decided to try skaffold for continuous development and deployment.
Login to ECR automatically with skaffold
We use private ECR as artifacts repositories, so we need to log in before being able to push.
One solution we found is to create a simple script to perform a docker login:





tmp=${SKAFFOLD_IMAGE_REPO#*ecr.}
REGION=${tmp%.amazonaws*}	
aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $SKAFFOLD_IMAGE_REPOAnd having this script be called by skaffold before every push:"><meta name=author content><meta name=keywords content><meta property="og:url" content="https://blog.thibaud.io/posts/archives/skaffold-ecr-replication/"><meta property="og:site_name" content="rheneross"><meta property="og:title" content="Skaffold with ECR and replication"><meta property="og:description" content="Our product is deployed on kubernetes, and the dev team was working locally; which meant a lot of integration issues.
We decided to try skaffold for continuous development and deployment.
Login to ECR automatically with skaffold We use private ECR as artifacts repositories, so we need to log in before being able to push.
One solution we found is to create a simple script to perform a docker login:
tmp=${SKAFFOLD_IMAGE_REPO#*ecr.} REGION=${tmp%.amazonaws*}	aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $SKAFFOLD_IMAGE_REPOAnd having this script be called by skaffold before every push:"><meta property="og:locale" content="en_US"><meta property="og:type" content="article"><meta property="article:section" content="posts"><meta property="article:published_time" content="2022-07-18T17:17:35+02:00"><meta property="article:modified_time" content="2022-07-18T17:17:35+02:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="Skaffold with ECR and replication"><meta name=twitter:description content="Our product is deployed on kubernetes, and the dev team was working locally; which meant a lot of integration issues.
We decided to try skaffold for continuous development and deployment.
Login to ECR automatically with skaffold We use private ECR as artifacts repositories, so we need to log in before being able to push.
One solution we found is to create a simple script to perform a docker login:
tmp=${SKAFFOLD_IMAGE_REPO#*ecr.} REGION=${tmp%.amazonaws*}	aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $SKAFFOLD_IMAGE_REPOAnd having this script be called by skaffold before every push:"><meta itemprop=name content="Skaffold with ECR and replication"><meta itemprop=description content="Our product is deployed on kubernetes, and the dev team was working locally; which meant a lot of integration issues.
We decided to try skaffold for continuous development and deployment.
Login to ECR automatically with skaffold We use private ECR as artifacts repositories, so we need to log in before being able to push.
One solution we found is to create a simple script to perform a docker login:
tmp=${SKAFFOLD_IMAGE_REPO#*ecr.} REGION=${tmp%.amazonaws*}	aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $SKAFFOLD_IMAGE_REPOAnd having this script be called by skaffold before every push:"><meta itemprop=datePublished content="2022-07-18T17:17:35+02:00"><meta itemprop=dateModified content="2022-07-18T17:17:35+02:00"><meta itemprop=wordCount content="369"><meta name=referrer content="no-referrer-when-downgrade"><link href=/original.min.css rel=stylesheet><link href=/syntax.min.css rel=stylesheet></head><body><header><a class=skip-link href=#main-content>Skip to main content</a><nav><a href=/>home</a>
<a href=/posts/>posts</a></nav></header><main id=main-content><h1>Skaffold with ECR and replication</h1><content><p>Our product is deployed on kubernetes, and the dev team was working locally; which meant a lot of integration issues.<br>We decided to try skaffold for continuous development and deployment.</p><h2 id=login-to-ecr-automatically-with-skaffold>Login to ECR automatically with skaffold</h2><p>We use private ECR as artifacts repositories, so we need to log in before being able to push.</p><p>One solution we found is to create a simple script to perform a <code>docker login</code>:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>tmp<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>SKAFFOLD_IMAGE_REPO#*ecr.<span style=color:#e6db74>}</span>
</span></span><span style=display:flex><span>REGION<span style=color:#f92672>=</span><span style=color:#e6db74>${</span>tmp%.amazonaws*<span style=color:#e6db74>}</span>	
</span></span><span style=display:flex><span>aws ecr get-login-password --region $REGION | docker login --username AWS --password-stdin $SKAFFOLD_IMAGE_REPO</span></span></code></pre></div><p>And having this script be called by skaffold before every push:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>.docker_login</span>: <span style=color:#75715e>&amp;docker_login</span>
</span></span><span style=display:flex><span>  - <span style=color:#f92672>command</span>: [<span style=color:#e6db74>&#34;sh&#34;</span>, <span style=color:#e6db74>&#34;-c&#34;</span>, <span style=color:#e6db74>&#34;./docker-login.sh&#34;</span>]
</span></span><span style=display:flex><span>    <span style=color:#f92672>os</span>: [<span style=color:#ae81ff>darwin, linux]</span>
</span></span><span style=display:flex><span><span style=color:#f92672>apiVersion</span>: <span style=color:#ae81ff>skaffold/v2beta28</span>
</span></span><span style=display:flex><span><span style=color:#f92672>kind</span>: <span style=color:#ae81ff>Config</span>
</span></span><span style=display:flex><span><span style=color:#f92672>build</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>artifacts</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>image</span>: <span style=color:#ae81ff>my-image</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>hooks</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>before</span>: <span style=color:#75715e>*docker_login</span></span></span></code></pre></div><h2 id=production-pipeline-gotchas>Production pipeline gotchas</h2><p>This is working fine in a development environment, a quick <code>skaffold dev</code> and everything is built, deployed and watched.<br>But we faced several issues when integrating skaffold with our CD pipeline.</p><h3 id=docker-login-in-the-pre-deploy-hook>Docker login in the pre-deploy hook</h3><p>One thing we didn&rsquo;t see was that <code>$SKAFFOLD_IMAGE_REPO</code> is not available in skaffold deploy hooks, only build hooks.
We updated our docker-login script to use <code>$SKAFFOLD_DEFAULT_REPO</code> instead, but we found out that it was not made available by <code>skaffold config set default-repo</code>, only when exporting the environment variable.</p><h3 id=artifactsjson>artifacts.json</h3><p>We have multiple EKS clusters spread around the world and, to speed-up pod boot time, we use a regional registry for each cluster.<br>We have replication enabled, so we only need to push to the main registry, but each cluster is pulling from a different one.</p><figure><img src=/svgs/replication.svg alt="Hello Friend"></figure><p>When building with <code>skaffold build --file-output artifacts.json</code>, artifacts are referenced with their full path:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;builds&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;imageName&#34;</span>: <span style=color:#e6db74>&#34;my-image&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;some-account.dkr.ecr.some-region.amazonaws.com/my-image:my-tag@sha256:meow&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}</span></span></code></pre></div><p>Even with a default repository set, <code>skaffold deploy -a artifacts.json</code> don&rsquo;t rewrite the path of the images&mldr; but, as we just saw, we are using a different one for each cluster!</p><p>Our quick solution was to build a small wrapper for our build process, which remove the registry from the image path:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-sh data-lang=sh><span style=display:flex><span>echo <span style=color:#66d9ef>$(</span>skaffold build -q $@ | jq <span style=color:#e6db74>&#39;.builds[].tag |=(sub(&#34;^.+/&#34;; &#34;&#34;))&#39;</span><span style=color:#66d9ef>)</span> &gt; <span style=color:#e6db74>&#34;artifacts.json&#34;</span></span></span></code></pre></div><p>Now the images in our <code>artifacts.json</code> file are referenced only by their names, and skaffold deploy prepend the default repository as expected:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;builds&#34;</span>: [
</span></span><span style=display:flex><span>    {
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;imageName&#34;</span>: <span style=color:#e6db74>&#34;my-image&#34;</span>,
</span></span><span style=display:flex><span>      <span style=color:#f92672>&#34;tag&#34;</span>: <span style=color:#e6db74>&#34;my-image:my-tag@sha256:meow&#34;</span>
</span></span><span style=display:flex><span>    }
</span></span><span style=display:flex><span>  ]
</span></span><span style=display:flex><span>}</span></span></code></pre></div></content><p></p></main><footer><small><a href=https://blog.thibaud.io/index.xml>RSS</a> | <a href=https://bsky.app/profile/rheneross.com>bluesky</a> | Made with <a href=https://github.com/clente/hugo-bearcub>Bear Cub</a></small></footer></body></html>